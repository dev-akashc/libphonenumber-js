<html>
	<head>
		<title>libphonenumber-js</title>

		<script src="https://unpkg.com/react@15.3.1/dist/react.js"></script>
		<script src="https://unpkg.com/react-dom@15.3.1/dist/react-dom.js"></script>
		<script src="https://unpkg.com/babel-core@5.8.38/browser.min.js"></script>

		<script src="./input-format.min.js"></script>
		<script src="./libphonenumber-js.min.js"></script>

		<meta charset="utf-8"/>
	</head>

	<style>
		body
		{
			padding: 40px;
		}

		body, input, button, textarea
		{
			font-family: Arial, Helvetica;
			font-size: 20px;
		}

		input[type="tel"],
		input[type="text"]
		{
			padding-bottom: 4px;
			border: none;
			border-bottom: 1px solid #0093C4;
			outline: none;
		}

		h2
		{
			margin-top: 60px;
			margin-bottom: 40px;
			border-bottom: 1px solid #afafaf;
		}

		h2:first-child
		{
			margin-top: 0;
		}

		.section
		{
			margin-top: 20px;
		}

		a
		{
			text-decoration: none;
			color: #0093C4;
		}

		a:hover
		{
			text-decoration: underline;
		}

		a.main
		{
			display: block;
			font-size: 32px;
		}

		p
		{
			margin-top: 10px;
			margin-bottom: 40px;
		}

		pre
		{
			margin-top: 50px;
			margin-bottom: 40px;
			padding: 20px;
			border: 1px solid #cfcfcf;
			border-radius: 4px;
			background: #fafafa;
		}

		button
		{
			display: block;
			margin-top: 10px;

			background : none;
			border     : none;
			outline    : none;
			padding    : 0;

			white-space: nowrap;

			color: #0093C4;
		}

		.section__line
		{
			margin-top: 10px;
			margin-bottom: 10px;
		}

		.find-numbers-text, .find-numbers-highlighted
		{
			display: block;
			box-sizing: border-box;
			width: 100%;
			line-height: 1.35em;
		}

		.find-numbers-text
		{
			min-height: 250px;
			padding: 15px;
			margin-bottom: 40px;
		}

		.find-numbers-highlighted
		{
			margin-top: 20px;
			margin-bottom: 20px;
		}

		.numbers-found li
		{
			margin-top: 15px;
			margin-bottom: 15px;
		}

		mark
		{
			background-color: #b1d5e5;
			border-radius: 5px;
			padding-left: 5px;
			padding-right: 5px;
			padding-top: 3px;
			padding-bottom: 3px;
		}
	</style>

	<body>
		<a target="_blank" class="main" href="https://github.com/catamphetamine/libphonenumber-js"><code>libphonenumber-js</code></a>

		<p>A simpler and smaller rewrite of Google Android's <a target="_blank" href="https://github.com/googlei18n/libphonenumber">libphonenumber</a> library</p>

		<div id="content"></div>

		<script type="text/babel">
			var Content = React.createClass
			({
				getInitialState: function()
				{
					return {
						value   : '+12133734253',
						parse   : '213-373-4253',
						format  : '2133734253',
						country : 'US',
						findNumbers : 'The number is +7 (800) 555-35-35 and not (213) 373-4253 as written in the document.'
					}
				},

				render: function()
				{
					// const libphonenumber = window.libphonenumber
					const input_format   = window['input-format']

					const ReactInput        = input_format.ReactInput
					const templateParser    = input_format.templateParser
					const templateFormatter = input_format.templateFormatter
					const parseDigit        = input_format.parseDigit

					let asYouType
					let parsed_number = '-'
					let parsed_number_extended = '-'
					let national_formatted_number = '-'
					let international_formatted_number = '-'
					let international_formatted_number_in_E164 = '-'
					let international_formatted_number_in_RFC3966 = '-'
					let numbers_found = []

					const { country, parse, format, value, findNumbers } = this.state

					try
					{
						asYouType = new libphonenumber.AsYouType(country)
						asYouType.input(value)

						parsed_number = JSON.stringify(libphonenumber.parseNumber(parse, country))
						parsed_number_extended = JSON.stringify(libphonenumber.parseNumber(parse, country, { extended: true }))

						const number_to_format = libphonenumber.parseNumber(format, country, { extended: true })

						if (number_to_format.phone)
						{
							national_formatted_number = libphonenumber.formatNumber(number_to_format, 'National')
							international_formatted_number = libphonenumber.formatNumber(number_to_format, 'International')
							international_formatted_number_in_E164 = libphonenumber.formatNumber(number_to_format, 'E.164')
							international_formatted_number_in_RFC3966 = libphonenumber.formatNumber(number_to_format, 'RFC3966')
						}

						numbers_found = libphonenumber.findNumbers(findNumbers, country)
					}
					catch (error)
					{
						if (error.message.indexOf('Unknown country') === 0)
						{
							//
						}
						else
						{
							throw error
						}
					}

					return (
						<div>
							<h2>As you type</h2>

							{/* type="tel" introduces bugs on Samsung Android phones */}
							{/* https://github.com/catamphetamine/react-phone-number-input/issues/59 */}
							<ReactInput
								autoFocus
								value={this.state.value}
								onChange={value => this.setState({ value })}
								parse={(character, value) =>
								{
									// Leading plus is allowed
									if (character === '+')
									{
										if (!value)
										{
											return character
										}
									}

									// Digits are allowed
									return parseDigit(character)
								}}
								format={(value) =>
								{
									let text
									let template

									try
									{
										const asYouType = new libphonenumber.AsYouType(this.state.country)
										text = asYouType.input(value)
										template = asYouType.template
									}
									catch (error)
									{
										if (error.message.indexOf('Unknown country') === 0)
										{
											text = value
											template = value.replace(/./g, 'x')
										}
										else
										{
											throw error
										}
									}

									return { text, template }
								}}/>

							<div className="section">
								<div className="section__line">Value: {this.state.value}</div>
								<div className="section__line">Default country:
									<input
										type="text"
										value={this.state.country}
										onChange={event => this.setState({ country: event.target.value.toUpperCase() })}
										style={{ width: '40px', marginLeft: '6px' }}/>
								</div>
								<div className="section__line">Actual country: {asYouType ? asYouType.country : '-'}</div>
								<div className="section__line">National: {asYouType ? asYouType.country && libphonenumber.formatNumber(asYouType.getNationalNumber(), asYouType.country, 'National') : '-'}</div>
								<div className="section__line">Valid: {asYouType ? String(libphonenumber.isValidNumber(this.state.value, asYouType.country)) : '-'}</div>
								<div className="section__line">Template: {asYouType ? asYouType.getTemplate() : '-'}</div>

								<br/>

								Note: Phone number validation here is loose because it uses the (default) reduced metadata set. For more precise phone number validation use <code>metadata.full.json</code>. <a href="https://github.com/catamphetamine/libphonenumber-js#isvalidnumberparsednumber">Read more</a>
							</div>

							<h2>Parse</h2>

							<input
								type="text"
								value={this.state.country}
								onChange={event => this.setState({ country: event.target.value.toUpperCase() })}
								style={{ width: '40px', marginRight: '10px' }}/>

							<input
								type="text"
								value={this.state.parse}
								onChange={event => this.setState({ parse: event.target.value })}/>

							<div className="section">
								<code>{parsed_number}</code>
							</div>

							<h2>Parse (extended)</h2>

							<input
								type="text"
								value={this.state.country}
								onChange={event => this.setState({ country: event.target.value.toUpperCase() })}
								style={{ width: '40px', marginRight: '10px' }}/>

							<input
								type="text"
								value={this.state.parse}
								onChange={event => this.setState({ parse: event.target.value })}/>

							<div className="section">
								<code>{parsed_number_extended}</code>
							</div>

							<h2>Format</h2>

							<input
								type="text"
								value={this.state.country}
								onChange={event => this.setState({ country: event.target.value.toUpperCase() })}
								style={{ width: '40px', marginRight: '10px' }}/>

							<input
								type="text"
								value={this.state.format}
								onChange={event => this.setState({ format: event.target.value })}/>

							<div className="section">
								<div className="section__line"><code>National: {national_formatted_number}</code></div>
								<div className="section__line"><code>International: {international_formatted_number}</code></div>
								<div className="section__line"><code>E.164: {international_formatted_number_in_E164}</code></div>
								<div className="section__line"><code>RFC3966: {international_formatted_number_in_RFC3966}</code></div>
							</div>

							<h2>Find phone numbers</h2>

							<textarea
								value={this.state.findNumbers}
								onChange={event => this.setState({ findNumbers: event.target.value })}
								className="find-numbers-text"/>

							{ numbers_found.length === 0 && 'No phone numbers found' }
							{ numbers_found.length > 0 && 'Phone numbers found: ' + numbers_found.length }

							{ numbers_found.length > 0 &&
								<ContentEditable
									html={highlight_phones(this.state.findNumbers, numbers_found)}
									onChange={event => this.setState({ findNumbers: strip_marks(event.target.value) })}
									readOnly
									className="find-numbers-highlighted" />
							}

							{ numbers_found.length > 0 &&
								<ul className="numbers-found">
									{numbers_found.map((number, i) => (
										<li key={i}>
											Country: {number.country},
											Phone: {number.phone},
											Starts at: {number.startsAt},
											Ends at: {number.endsAt}
										</li>
									))}
								</ul>
							}
						</div>
					)
				}
			})

			// https://stackoverflow.com/questions/22677931/react-js-onchange-event-for-contenteditable/27255103#27255103
			var ContentEditable = React.createClass({
				render: function(){
					return <div id="contenteditable"
						onInput={this.emitChange}
						onBlur={this.emitChange}
						className={this.props.className}
						contentEditable={!this.props.readOnly}
						dangerouslySetInnerHTML={{__html: this.props.html}}></div>;
				},

				getDOMNode: function() {
					return ReactDOM.findDOMNode(this);
				},

				shouldComponentUpdate: function(nextProps) {
					return nextProps.html !== this.getDOMNode().innerHTML;
				},

				componentDidUpdate: function() {
					if ( this.props.html !== this.getDOMNode().innerHTML ) {
						this.getDOMNode().innerHTML = this.props.html;
					}
				},

				emitChange: function() {
					var html = this.getDOMNode().innerHTML;
					if (this.props.onChange && html !== this.lastHtml) {
						this.props.onChange({
							target: {
								value: html
							}
						});
					}
					this.lastHtml = html;
				}
			})

			ReactDOM.render
			(
				<Content />,
				document.getElementById('content')
			)

			function highlight_phones(html, phones)
			{
				let endedAt = 0
				return phones.reduce((result, { startsAt, endsAt }) => {
					const previousEndsAt = endedAt
					endedAt = endsAt
					return result +
						html.slice(previousEndsAt, startsAt) +
						'<mark>' +
						html.slice(startsAt, endsAt) +
						'</mark>'
				}, '') + html.slice(endedAt)
			}

			function strip_marks(html)
			{
				return html.replace(/<\/?mark>/g, '')
			}
		</script>
	</body>
</html>